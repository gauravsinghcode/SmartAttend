{% extends "attendance/base.html" %}
{% load static %}
{% block bodyblock %}
{% load extra_filters %}

<div class="min-h-screen bg-gradient-to-br from-white via-gray-50 to-gray-100 py-10 px-4">

    <div class="max-w-5xl mx-auto bg-white/70 backdrop-blur-md shadow-xl rounded-2xl p-8 border border-gray-200/50">

        <h1 class="text-3xl font-bold text-indigo-900 font-[Nunito] mb-6">
            Attendance Reports
        </h1>

        <!-- Summary Cards -->
        <div class="grid md:grid-cols-3 gap-6 mb-10">
            
            <div class="p-6 rounded-xl bg-white border border-gray-200 shadow-sm">
                <h3 class="text-gray-500 text-sm">Total Sessions</h3>
                <p class="text-3xl font-bold text-indigo-800 mt-1">{{ total_sessions }}</p>
            </div>

            <div class="p-6 rounded-xl bg-white border border-gray-200 shadow-sm">
                <h3 class="text-gray-500 text-sm">Total Attendance Marked</h3>
                <p class="text-3xl font-bold text-indigo-800 mt-1">{{ total_attendance }}</p>
            </div>

            <div class="p-6 rounded-xl bg-white border border-gray-200 shadow-sm">
                <h3 class="text-gray-500 text-sm">Average Per Session</h3>
                <p class="text-3xl font-bold text-indigo-800 mt-1">
                    {% if total_sessions > 0 %}
                        {{ total_attendance|divisibleby:total_sessions }}
                    {% else %}
                        0
                    {% endif %}
                </p>
            </div>

        </div>

        <!-- Charts -->
        <div class="grid md:grid-cols-2 gap-8">

            <div class="bg-white p-6 rounded-xl border shadow">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Session Attendance Chart</h2>
                <canvas id="barChart"></canvas>
            </div>

            <div class="bg-white p-6 rounded-xl border shadow">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">Attendance Distribution</h2>
                <canvas id="pieChart"></canvas>
            </div>

        </div>

        <!-- Session Table -->
        <div class="mt-10">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Session-wise Attendance</h2>

            {% if session_data %}
            <div class="overflow-x-auto rounded-xl border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200 text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="py-2 px-4">Session</th>
                            <th class="py-2 px-4">Created</th>
                            <th class="py-2 px-4">Present</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        {% for s in session_data %}
                        <tr>
                            <td class="py-2 px-4">{{ s.title }}</td>
                            <td class="py-2 px-4">{{ s.created|date:"M d, H:i" }}</td>
                            <td class="py-2 px-4">{{ s.count }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <p class="text-gray-500">No sessions available.</p>
            {% endif %}
        </div>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{{ session_data|json_script:"sessionDataJson" }}

<script>
    const sessionData = JSON.parse(
        document.getElementById("sessionDataJson").textContent
    );

    const reportSessionLabels = sessionData.map(item => item.title);
    const reportAttendanceCounts = sessionData.map(item => item.count);

    const barCtx = document.getElementById('barChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: reportSessionLabels,
            datasets: [{
                label: 'Attendance Count',
                data: reportAttendanceCounts,
                backgroundColor: '#312c85',
            }]
        }
    });

    const pieCtx = document.getElementById('pieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: reportSessionLabels,
            datasets: [{
                data: reportAttendanceCounts,
                backgroundColor: ['#312c85', '#22c55e', '#fde047', '#f87171', '#60a5fa'],
            }]
        }
    });
</script>


{% endblock %}
