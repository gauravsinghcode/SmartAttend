{% extends "attendance/base.html" %}
{% load static %}
{% block bodyblock %}

<!-- ðŸŒŸ Page Container -->
<div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-b from-white via-gray-50 to-gray-100 px-4 py-10">

  <!-- ðŸ“¦ Card -->
  <div class="w-full max-w-lg bg-white shadow-xl rounded-2xl border border-gray-100 p-6">
    <h1 class="text-2xl font-semibold text-gray-800 mb-2 text-center">
      Scan Attendance QR
    </h1>
    <p class="text-gray-500 text-center mb-6">
      Allow camera access and point it at the QR shown by your teacher to mark your attendance.
    </p>

    <!-- ðŸ“· QR Reader -->
    <div id="reader" class="rounded-lg border border-gray-300 shadow-sm w-full mb-4 overflow-hidden"></div>

    <!-- ðŸ’¡ Status Message -->
    <div id="statusMsg" class="text-center text-sm text-gray-700 font-medium mb-4"></div>

    <!-- ðŸ§¾ Manual Fallback -->
    <div class="flex items-center gap-2">
      <input
        id="manualToken"
        type="text"
        placeholder="Paste code or URL here"
        class="flex-1 border border-gray-300 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"
      />
      <button
        id="manualSubmit"
        class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-all duration-150"
      >
        Submit
      </button>
    </div>

    <p class="text-xs text-gray-400 text-center mt-4">
      If camera access is blocked, enable camera permissions in your browser settings.
    </p>
  </div>
</div>

<!-- âœ… Load the QR Scanner Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<!-- ðŸ§  Scanner Logic -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const readerDiv = document.getElementById("reader");
  const status = document.getElementById("statusMsg");

  // âœ… Create QR scanner instance
  const html5QrCode = new Html5Qrcode("reader");

  // âœ… Try starting the camera
  Html5Qrcode.getCameras()
    .then((devices) => {
      if (devices && devices.length) {
        const cameraId =
          devices.find((d) => /back|rear|environment/gi.test(d.label))?.id ||
          devices[0].id;

        html5QrCode
          .start(
            cameraId,
            {
              fps: 10,
              qrbox: { width: 250, height: 250 },
            },
            (decodedText) => {
              const token = decodedText.split("/").pop().trim();
              html5QrCode.stop();
              showStatus("Processing QR...", "text-emerald-600");
              sendToken(token);
            },
            (error) => {
              // optional: console.log(error)
            }
          )
          .catch((err) => {
            showStatus("Unable to access camera. " + err, "text-red-500");
          });
      } else {
        showStatus("No camera found on this device.", "text-red-500");
      }
    })
    .catch((err) => {
      showStatus("Camera permission denied: " + err, "text-red-500");
    });

  // âœ… Manual fallback submit
  document.getElementById("manualSubmit").addEventListener("click", () => {
    const token = document.getElementById("manualToken").value.trim();
    if (!token) {
      showStatus("Please paste a token or URL.", "text-red-500");
      return;
    }
    sendToken(token);
  });

  // âœ… Send scanned token to backend
  function sendToken(token) {
    const csrftoken = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)')?.pop();
    const formData = new FormData();
    formData.append("token", token);

    fetch("{% url 'mark_attendance_ajax' %}", {
      method: "POST",
      headers: { "X-CSRFToken": csrftoken },
      body: formData,
      credentials: "include",
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.ok) {
          showStatus("âœ… Attendance marked successfully!", "text-emerald-600");
          readerDiv.classList.add("border-emerald-400", "shadow-emerald-200");
          setTimeout(() => (window.location.href = "{% url 'app-dashboard' %}"), 1000);
        } else {
          showStatus("âš ï¸ " + data.msg, "text-red-500");
          restartCamera();
        }
      })
      .catch((err) => {
        showStatus("Network error: " + err, "text-red-500");
        restartCamera();
      });
  }

  // âœ… Helper: Update message dynamically
  function showStatus(msg, colorClass) {
    status.className = "text-center text-sm font-medium mt-2 " + colorClass;
    status.innerText = msg;
  }

  // âœ… Restart camera after an error
  function restartCamera() {
    Html5Qrcode.getCameras().then((devices) => {
      const cameraId = devices[0].id;
      html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, () => {}, () => {});
    });
  }
});
</script>

{% endblock %}
